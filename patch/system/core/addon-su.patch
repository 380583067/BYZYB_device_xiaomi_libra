From 66e518bc1b5f1ab0a60d98d77e9da26a90a769e0 Mon Sep 17 00:00:00 2001
From: WJXXBSH <zyb_1998@outlook.com>
Date: Wed, 4 Nov 2020 23:44:34 +0800
Subject: [PATCH] Forwardport addon-su from lineage-16.0

Change-Id: I9cf563ee2105f1d4a709b38d9f180713219b0d19
---
 adb/daemon/main.cpp          | 3 ++-
 adb/root/adbroot_service.cpp | 7 +++++--
 2 files changed, 7 insertions(+), 3 deletions(-)

diff --git a/adb/daemon/main.cpp b/adb/daemon/main.cpp
index 8521b5f..828a5cb 100644
--- a/adb/daemon/main.cpp
+++ b/adb/daemon/main.cpp
@@ -69,6 +69,7 @@ static bool should_drop_privileges() {
     //
     // ro.secure:
     //   Drop privileges by default. Set to 1 on userdebug and user builds.
+    bool persist_sys_root_access = android::base::GetBoolProperty("persist.sys.root_access", false);
     bool ro_secure = android::base::GetBoolProperty("ro.secure", true);
     bool ro_debuggable = __android_log_is_debuggable();

@@ -79,7 +80,7 @@ static bool should_drop_privileges() {
     std::string prop = android::base::GetProperty("service.adb.root", "");
     bool adb_root = (prop == "1");
     bool adb_unroot = (prop == "0");
-    if (ro_debuggable && adb_root) {
+    if (ro_debuggable || (adb_root && persist_sys_root_access)) {
         drop = false;
     }
     // ... and "adb unroot" lets you explicitly drop privileges.
diff --git a/adb/root/adbroot_service.cpp b/adb/root/adbroot_service.cpp
index b0c7ece..37a4987 100644
--- a/adb/root/adbroot_service.cpp
+++ b/adb/root/adbroot_service.cpp
@@ -66,8 +66,11 @@ binder::Status ADBRootService::setEnabled(bool enabled) {
         enabled_ = enabled;
         WriteStringToFile(std::to_string(enabled), kStoragePath + kEnabled);

-        // Turning off adb root, restart adbd.
-        if (!enabled) {
+        // Turning on/off adb root, restart adbd.
+        if (enabled) {
+            base::SetProperty("service.adb.root", "1");
+            base::SetProperty("ctl.restart", "adbd");
+        } else {
             base::SetProperty("service.adb.root", "0");
             base::SetProperty("ctl.restart", "adbd");
         }
--
2.27.0
