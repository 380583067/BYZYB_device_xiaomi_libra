From cfe969ed09b1022db4664a9f92768a2e481fc152 Mon Sep 17 00:00:00 2001
From: WJXXBSH <********@outlook.com>
Date: Mon, 7 Sep 2020 11:21:14 +0800
Subject: [PATCH] system_sepolicy_UserBuild

Change-Id: I5644812cc529f0389e6f1d551c1c24407f8414a7
---
 Android.mk                                       | 12 ++++++------
 prebuilts/api/29.0/private/adbd.te               |  6 +++---
 .../api/29.0/private/compat/26.0/26.0.ignore.cil |  3 +++
 prebuilts/api/29.0/private/logd.te               |  2 +-
 prebuilts/api/29.0/private/su.te                 |  4 ++--
 prebuilts/api/29.0/private/untrusted_app_25.te   |  1 +
 prebuilts/api/29.0/private/untrusted_app_all.te  |  1 +
 prebuilts/api/29.0/public/app.te                 |  4 ++--
 prebuilts/api/29.0/public/domain.te              | 16 ++++++++--------
 prebuilts/api/29.0/public/hal_configstore.te     |  2 +-
 prebuilts/api/29.0/public/installd.te            |  2 +-
 prebuilts/api/29.0/public/netd.te                |  2 +-
 prebuilts/api/29.0/public/su.te                  |  4 ++--
 prebuilts/api/29.0/public/te_macros              |  8 ++++----
 prebuilts/api/29.0/public/vold.te                |  2 +-
 private/adbd.te                                  |  6 +++---
 private/compat/26.0/26.0.ignore.cil              |  3 +++
 private/logd.te                                  |  2 +-
 private/su.te                                    |  4 ++--
 private/untrusted_app_25.te                      |  1 +
 private/untrusted_app_all.te                     |  1 +
 public/app.te                                    |  4 ++--
 public/domain.te                                 | 16 ++++++++--------
 public/hal_configstore.te                        |  2 +-
 public/installd.te                               |  2 +-
 public/netd.te                                   |  2 +-
 public/su.te                                     |  4 ++--
 public/te_macros                                 |  8 ++++----
 public/vold.te                                   |  2 +-
 29 files changed, 68 insertions(+), 58 deletions(-)

diff --git a/Android.mk b/Android.mk
index dadd7b0a..1c922225 100644
--- a/Android.mk
+++ b/Android.mk
@@ -81,10 +81,12 @@ ifndef BOARD_SEPOLICY_VERS
 BOARD_SEPOLICY_VERS := $(PLATFORM_SEPOLICY_VERSION)
 endif

-NEVERALLOW_ARG :=
+# Hacks to keep SELinux permissive in user builds
+SELINUX_IGNORE_NEVERALLOWS := true
+
 ifeq ($(SELINUX_IGNORE_NEVERALLOWS),true)
 ifeq ($(TARGET_BUILD_VARIANT),user)
-$(error SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
+$(warning SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
 endif
 $(warning Be careful when using the SELINUX_IGNORE_NEVERALLOWS flag. \
           It does not work in user builds and using it will \
@@ -980,10 +982,9 @@ $(built_sepolicy_neverallows)
 	$(hide) $(HOST_OUT_EXECUTABLES)/sepolicy-analyze $@.tmp permissive > $@.permissivedomains
 	$(hide) if [ "$(TARGET_BUILD_VARIANT)" = "user" -a -s $@.permissivedomains ]; then \
 		echo "==========" 1>&2; \
-		echo "ERROR: permissive domains not allowed in user builds" 1>&2; \
+		echo "WARNING: permissive domains not allowed in user builds" 1>&2; \
 		echo "List of invalid domains:" 1>&2; \
 		cat $@.permissivedomains 1>&2; \
-		exit 1; \
 		fi
 	$(hide) mv $@.tmp $@

@@ -1034,10 +1035,9 @@ $(LOCAL_BUILT_MODULE): $(sepolicy.recovery.conf) $(HOST_OUT_EXECUTABLES)/checkpo
 	$(hide) $(HOST_OUT_EXECUTABLES)/sepolicy-analyze $@.tmp permissive > $@.permissivedomains
 	$(hide) if [ "$(TARGET_BUILD_VARIANT)" = "user" -a -s $@.permissivedomains ]; then \
 		echo "==========" 1>&2; \
-		echo "ERROR: permissive domains not allowed in user builds" 1>&2; \
+		echo "WARNING: permissive domains not allowed in user builds" 1>&2; \
 		echo "List of invalid domains:" 1>&2; \
 		cat $@.permissivedomains 1>&2; \
-		exit 1; \
 		fi
 	$(hide) mv $@.tmp $@

diff --git a/prebuilts/api/29.0/private/adbd.te b/prebuilts/api/29.0/private/adbd.te
index ec5c57ee..48325142 100644
--- a/prebuilts/api/29.0/private/adbd.te
+++ b/prebuilts/api/29.0/private/adbd.te
@@ -7,10 +7,10 @@ init_daemon_domain(adbd)

 domain_auto_trans(adbd, shell_exec, shell)

-userdebug_or_eng(`
+
   allow adbd self:process setcurrent;
   allow adbd su:process dyntransition;
-')
+

 # When 'adb shell' is executed in recovery mode, adbd explicitly
 # switches into shell domain using setcon() because the shell executable
@@ -191,4 +191,4 @@ allow adbd shell:fd use;
 # transitions to the shell domain (except when it crashes). In particular, we
 # never want to see a transition from adbd to su (aka "adb root")
 neverallow adbd { domain -crash_dump -shell }:process transition;
-neverallow adbd { domain userdebug_or_eng(`-su') recovery_only(`-shell') }:process dyntransition;
+neverallow adbd { domain -su -shell }:process dyntransition;
diff --git a/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil b/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
index b12f917d..ee5efbbc 100644
--- a/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
+++ b/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
@@ -225,3 +225,6 @@
   ( priv_objects
     adbd_tmpfs
     untrusted_app_27_tmpfs))
+
+allow sudaemon untrusted_app_all_devpts:chr_file *;
+allow untrusted_app untrusted_app_all_devpts:chr_file *;
diff --git a/prebuilts/api/29.0/private/logd.te b/prebuilts/api/29.0/private/logd.te
index ca92e206..7e2d23d7 100644
--- a/prebuilts/api/29.0/private/logd.te
+++ b/prebuilts/api/29.0/private/logd.te
@@ -33,6 +33,6 @@ neverallow {
   -priv_app
   -radio
   -shell
-  userdebug_or_eng(`-su')
+  -su
   -system_app
 } runtime_event_log_tags_file:file no_rw_file_perms;
diff --git a/prebuilts/api/29.0/private/su.te b/prebuilts/api/29.0/private/su.te
index 16e47bbb..27a97bdb 100644
--- a/prebuilts/api/29.0/private/su.te
+++ b/prebuilts/api/29.0/private/su.te
@@ -1,4 +1,4 @@
-userdebug_or_eng(`
+
   typeattribute su coredomain;

   domain_auto_trans(shell, su_exec, su)
@@ -20,4 +20,4 @@ userdebug_or_eng(`
   permissive su;

   app_domain(su)
-')
+
diff --git a/prebuilts/api/29.0/private/untrusted_app_25.te b/prebuilts/api/29.0/private/untrusted_app_25.te
index a35d81bd..e1b5136d 100644
--- a/prebuilts/api/29.0/private/untrusted_app_25.te
+++ b/prebuilts/api/29.0/private/untrusted_app_25.te
@@ -41,6 +41,7 @@ allow untrusted_app_25 proc_misc:file r_file_perms;
 # https://github.com/strazzere/anti-emulator/blob/master/AntiEmulator/src/diff/strazzere/anti/emulator/FindEmulator.java
 # This will go away in a future Android release
 allow untrusted_app_25 proc_tty_drivers:file r_file_perms;
+allow untrusted_app socket_device:sock_file *;

 # Text relocation support for API < 23. This is now disallowed for targetSdkVersion>=Q.
 # https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md#text-relocations-enforced-for-api-level-23
diff --git a/prebuilts/api/29.0/private/untrusted_app_all.te b/prebuilts/api/29.0/private/untrusted_app_all.te
index 89fb6cb2..9b8a4fbb 100644
--- a/prebuilts/api/29.0/private/untrusted_app_all.te
+++ b/prebuilts/api/29.0/private/untrusted_app_all.te
@@ -168,6 +168,7 @@ dontaudit untrusted_app_all net_dns_prop:file read;
 dontaudit untrusted_app_all proc_stat:file read;
 dontaudit untrusted_app_all proc_vmstat:file read;
 dontaudit untrusted_app_all proc_uptime:file read;
+allow untrusted_app socket_device:sock_file *;

 # Allow the allocation and use of ptys
 # Used by: https://play.google.com/store/apps/details?id=jackpal.androidterm
diff --git a/prebuilts/api/29.0/public/app.te b/prebuilts/api/29.0/public/app.te
index 5c48e71f..0586f6d3 100644
--- a/prebuilts/api/29.0/public/app.te
+++ b/prebuilts/api/29.0/public/app.te
@@ -193,7 +193,7 @@ r_dir_file({
   -untrusted_app_all
 }, proc_net_type)
 # audit access for all these non-core app domains.
-userdebug_or_eng(`
+
   auditallow {
     appdomain
     -ephemeral_app
@@ -205,7 +205,7 @@ userdebug_or_eng(`
     -system_app
     -untrusted_app_all
   } proc_net_type:{ dir file lnk_file } { getattr open read };
-')
+

 # Grant GPU access to all processes started by Zygote.
 # They need that to render the standard UI.
diff --git a/prebuilts/api/29.0/public/domain.te b/prebuilts/api/29.0/public/domain.te
index 6f3a19cd..497b4153 100644
--- a/prebuilts/api/29.0/public/domain.te
+++ b/prebuilts/api/29.0/public/domain.te
@@ -32,7 +32,6 @@ allow domain self:unix_stream_socket { create_stream_socket_perms connectto };
 # Inherit or receive open files from others.
 allow domain init:fd use;

-userdebug_or_eng(`
   allow domain su:fd use;
   allow domain su:unix_stream_socket { connectto getattr getopt read write shutdown };
   allow domain su:unix_dgram_socket sendto;
@@ -46,6 +45,7 @@ userdebug_or_eng(`
   # allow "gdbserver --attach" to work for su.
   allow domain su:process sigchld;

+userdebug_or_eng(`
   # Allow writing coredumps to /cores/*
   allow domain coredump_file:file create_file_perms;
   allow domain coredump_file:dir ra_dir_perms;
@@ -603,7 +603,7 @@ neverallow {
 # this partition for testing purposes.
 neverallow {
   domain
-  userdebug_or_eng(`-domain') # exclude debuggable builds
+  -domain # exclude debuggable builds
   -fastbootd
   -hal_bootctl_server
   -init
@@ -689,7 +689,7 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
     -ueventd # uevent is granted create for this device, but we still neverallow I/O below
   } vndbinder_device:chr_file rw_file_perms;
 ')
@@ -700,14 +700,14 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservice_manager_type:service_manager *;
 ')
 full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservicemanager:binder *;
 ')

@@ -743,7 +743,7 @@ full_treble_only(`
     -logd # Logging by writing to logd Unix domain socket is public API
     -netd # netdomain needs this
     -mdnsd # netdomain needs this
-    userdebug_or_eng(`-su') # communications with su are permitted only on userdebug or eng builds
+    -su # communications with su are permitted only on userdebug or eng builds
     -init
     -tombstoned # linker to tombstoned
     userdebug_or_eng('-heapprofd`)
@@ -1109,7 +1109,7 @@ neverallow * { file_type fs_type dev_type }:{ lnk_file fifo_file sock_file } mou
 # Nobody should be able to execute su on user builds.
 # On userdebug/eng builds, only dumpstate, shell, and
 # su itself execute su.
-neverallow { domain userdebug_or_eng(`-dumpstate -shell -su') } su_exec:file no_x_file_perms;
+neverallow { domain -dumpstate -shell -su } su_exec:file no_x_file_perms;

 # Do not allow the introduction of new execmod rules. Text relocations
 # and modification of executable pages are unsafe.
@@ -1197,7 +1197,7 @@ neverallow {
 # Only domains spawned from zygote, runas and simpleperf_app_runner may have the appdomain
 # attribute.
 neverallow { domain -simpleperf_app_runner -runas -app_zygote -webview_zygote -zygote } {
-  appdomain -shell userdebug_or_eng(`-su')
+  appdomain -shell -su
 }:process { transition dyntransition };

 # Minimize read access to shell- or app-writable symlinks.
diff --git a/prebuilts/api/29.0/public/hal_configstore.te b/prebuilts/api/29.0/public/hal_configstore.te
index 1a95b72f..edcdc267 100644
--- a/prebuilts/api/29.0/public/hal_configstore.te
+++ b/prebuilts/api/29.0/public/hal_configstore.te
@@ -31,7 +31,7 @@ neverallow hal_configstore_server {
   domain
   -hal_configstore_server
   -logd
-  userdebug_or_eng(`-su')
+  -su
   -tombstoned
   userdebug_or_eng(`-heapprofd')
 }:{ unix_dgram_socket unix_stream_socket } *;
diff --git a/prebuilts/api/29.0/public/installd.te b/prebuilts/api/29.0/public/installd.te
index f0ac52a0..eb78d9e6 100644
--- a/prebuilts/api/29.0/public/installd.te
+++ b/prebuilts/api/29.0/public/installd.te
@@ -173,5 +173,5 @@ neverallow installd {
     -ashmemd
     -system_server
     -servicemanager
-    userdebug_or_eng(`-su')
+    -su
 }:binder call;
diff --git a/prebuilts/api/29.0/public/netd.te b/prebuilts/api/29.0/public/netd.te
index c8877b24..540e04e9 100644
--- a/prebuilts/api/29.0/public/netd.te
+++ b/prebuilts/api/29.0/public/netd.te
@@ -158,7 +158,7 @@ neverallow {

 # apps may not interact with netd over binder.
 neverallow { appdomain -network_stack } netd:binder call;
-neverallow netd { appdomain -network_stack userdebug_or_eng(`-su') }:binder call;
+neverallow netd { appdomain -network_stack -su }:binder call;

 # persist.netd.stable_secret contains RFC 7217 secret key which should never be
 # leaked to other processes. Make sure it never leaks.
diff --git a/prebuilts/api/29.0/public/su.te b/prebuilts/api/29.0/public/su.te
index a2f435e1..b0ec6533 100644
--- a/prebuilts/api/29.0/public/su.te
+++ b/prebuilts/api/29.0/public/su.te
@@ -4,8 +4,8 @@ type su, domain;

 # File types must be defined for file_contexts.
 type su_exec, system_file_type, exec_type, file_type;
+type sudaemon, domain;

-userdebug_or_eng(`
   # Domain used for su processes, as well as for adbd and adb shell
   # after performing an adb root command.  The domain definition is
   # wrapped to ensure that it does not exist at all on -user builds.
@@ -101,4 +101,4 @@ userdebug_or_eng(`
   typeattribute su hal_wifi_hostapd_client;
   typeattribute su hal_wifi_offload_client;
   typeattribute su hal_wifi_supplicant_client;
-')
+
diff --git a/prebuilts/api/29.0/public/te_macros b/prebuilts/api/29.0/public/te_macros
index 85783dc9..f84c9c03 100644
--- a/prebuilts/api/29.0/public/te_macros
+++ b/prebuilts/api/29.0/public/te_macros
@@ -98,10 +98,10 @@ define(`pdx_service_socket_types', `
 typeattribute $2 pdx_$1_endpoint_dir_type;
 type pdx_$1_endpoint_socket, pdx_$1_endpoint_socket_type, pdx_endpoint_socket_type, file_type, coredomain_socket, mlstrustedobject, mlstrustedsubject;
 type pdx_$1_channel_socket, pdx_$1_channel_socket_type, pdx_channel_socket_type, coredomain_socket;
-userdebug_or_eng(`
+
 dontaudit su pdx_$1_endpoint_socket:unix_stream_socket *;
 dontaudit su pdx_$1_channel_socket:unix_stream_socket *;
-')
+
 ')

 #####################################
@@ -525,9 +525,9 @@ define(`build_test_only', ifelse(target_exclude_build_test, `true', , $1))
 # Fallback crash handling for processes that can't exec crash_dump (e.g. because of seccomp).
 #
 define(`crash_dump_fallback', `
-userdebug_or_eng(`
+
   allow $1 su:fifo_file append;
-')
+
 allow $1 anr_data_file:file append;
 allow $1 dumpstate:fd use;
 allow $1 incidentd:fd use;
diff --git a/prebuilts/api/29.0/public/vold.te b/prebuilts/api/29.0/public/vold.te
index 49523f43..0742ba3f 100644
--- a/prebuilts/api/29.0/public/vold.te
+++ b/prebuilts/api/29.0/public/vold.te
@@ -315,7 +315,7 @@ neverallow vold {
   -iorapd_service
   -servicemanager
   -system_server
-  userdebug_or_eng(`-su')
+  -su
 }:binder call;

 neverallow vold fsck_exec:file execute_no_trans;
diff --git a/private/adbd.te b/private/adbd.te
index ec5c57ee..48325142 100644
--- a/private/adbd.te
+++ b/private/adbd.te
@@ -7,10 +7,10 @@ init_daemon_domain(adbd)

 domain_auto_trans(adbd, shell_exec, shell)

-userdebug_or_eng(`
+
   allow adbd self:process setcurrent;
   allow adbd su:process dyntransition;
-')
+

 # When 'adb shell' is executed in recovery mode, adbd explicitly
 # switches into shell domain using setcon() because the shell executable
@@ -191,4 +191,4 @@ allow adbd shell:fd use;
 # transitions to the shell domain (except when it crashes). In particular, we
 # never want to see a transition from adbd to su (aka "adb root")
 neverallow adbd { domain -crash_dump -shell }:process transition;
-neverallow adbd { domain userdebug_or_eng(`-su') recovery_only(`-shell') }:process dyntransition;
+neverallow adbd { domain -su -shell }:process dyntransition;
diff --git a/private/compat/26.0/26.0.ignore.cil b/private/compat/26.0/26.0.ignore.cil
index b12f917d..ee5efbbc 100644
--- a/private/compat/26.0/26.0.ignore.cil
+++ b/private/compat/26.0/26.0.ignore.cil
@@ -225,3 +225,6 @@
   ( priv_objects
     adbd_tmpfs
     untrusted_app_27_tmpfs))
+
+allow sudaemon untrusted_app_all_devpts:chr_file *;
+allow untrusted_app untrusted_app_all_devpts:chr_file *;
diff --git a/private/logd.te b/private/logd.te
index ca92e206..7e2d23d7 100644
--- a/private/logd.te
+++ b/private/logd.te
@@ -33,6 +33,6 @@ neverallow {
   -priv_app
   -radio
   -shell
-  userdebug_or_eng(`-su')
+  -su
   -system_app
 } runtime_event_log_tags_file:file no_rw_file_perms;
diff --git a/private/su.te b/private/su.te
index 16e47bbb..27a97bdb 100644
--- a/private/su.te
+++ b/private/su.te
@@ -1,4 +1,4 @@
-userdebug_or_eng(`
+
   typeattribute su coredomain;

   domain_auto_trans(shell, su_exec, su)
@@ -20,4 +20,4 @@ userdebug_or_eng(`
   permissive su;

   app_domain(su)
-')
+
diff --git a/private/untrusted_app_25.te b/private/untrusted_app_25.te
index a35d81bd..e1b5136d 100644
--- a/private/untrusted_app_25.te
+++ b/private/untrusted_app_25.te
@@ -41,6 +41,7 @@ allow untrusted_app_25 proc_misc:file r_file_perms;
 # https://github.com/strazzere/anti-emulator/blob/master/AntiEmulator/src/diff/strazzere/anti/emulator/FindEmulator.java
 # This will go away in a future Android release
 allow untrusted_app_25 proc_tty_drivers:file r_file_perms;
+allow untrusted_app socket_device:sock_file *;

 # Text relocation support for API < 23. This is now disallowed for targetSdkVersion>=Q.
 # https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md#text-relocations-enforced-for-api-level-23
diff --git a/private/untrusted_app_all.te b/private/untrusted_app_all.te
index 89fb6cb2..9b8a4fbb 100644
--- a/private/untrusted_app_all.te
+++ b/private/untrusted_app_all.te
@@ -168,6 +168,7 @@ dontaudit untrusted_app_all net_dns_prop:file read;
 dontaudit untrusted_app_all proc_stat:file read;
 dontaudit untrusted_app_all proc_vmstat:file read;
 dontaudit untrusted_app_all proc_uptime:file read;
+allow untrusted_app socket_device:sock_file *;

 # Allow the allocation and use of ptys
 # Used by: https://play.google.com/store/apps/details?id=jackpal.androidterm
diff --git a/public/app.te b/public/app.te
index 5c48e71f..0586f6d3 100644
--- a/public/app.te
+++ b/public/app.te
@@ -193,7 +193,7 @@ r_dir_file({
   -untrusted_app_all
 }, proc_net_type)
 # audit access for all these non-core app domains.
-userdebug_or_eng(`
+
   auditallow {
     appdomain
     -ephemeral_app
@@ -205,7 +205,7 @@ userdebug_or_eng(`
     -system_app
     -untrusted_app_all
   } proc_net_type:{ dir file lnk_file } { getattr open read };
-')
+

 # Grant GPU access to all processes started by Zygote.
 # They need that to render the standard UI.
diff --git a/public/domain.te b/public/domain.te
index 6f3a19cd..497b4153 100644
--- a/public/domain.te
+++ b/public/domain.te
@@ -32,7 +32,6 @@ allow domain self:unix_stream_socket { create_stream_socket_perms connectto };
 # Inherit or receive open files from others.
 allow domain init:fd use;

-userdebug_or_eng(`
   allow domain su:fd use;
   allow domain su:unix_stream_socket { connectto getattr getopt read write shutdown };
   allow domain su:unix_dgram_socket sendto;
@@ -46,6 +45,7 @@ userdebug_or_eng(`
   # allow "gdbserver --attach" to work for su.
   allow domain su:process sigchld;

+userdebug_or_eng(`
   # Allow writing coredumps to /cores/*
   allow domain coredump_file:file create_file_perms;
   allow domain coredump_file:dir ra_dir_perms;
@@ -603,7 +603,7 @@ neverallow {
 # this partition for testing purposes.
 neverallow {
   domain
-  userdebug_or_eng(`-domain') # exclude debuggable builds
+  -domain # exclude debuggable builds
   -fastbootd
   -hal_bootctl_server
   -init
@@ -689,7 +689,7 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
     -ueventd # uevent is granted create for this device, but we still neverallow I/O below
   } vndbinder_device:chr_file rw_file_perms;
 ')
@@ -700,14 +700,14 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservice_manager_type:service_manager *;
 ')
 full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservicemanager:binder *;
 ')

@@ -743,7 +743,7 @@ full_treble_only(`
     -logd # Logging by writing to logd Unix domain socket is public API
     -netd # netdomain needs this
     -mdnsd # netdomain needs this
-    userdebug_or_eng(`-su') # communications with su are permitted only on userdebug or eng builds
+    -su # communications with su are permitted only on userdebug or eng builds
     -init
     -tombstoned # linker to tombstoned
     userdebug_or_eng('-heapprofd`)
@@ -1109,7 +1109,7 @@ neverallow * { file_type fs_type dev_type }:{ lnk_file fifo_file sock_file } mou
 # Nobody should be able to execute su on user builds.
 # On userdebug/eng builds, only dumpstate, shell, and
 # su itself execute su.
-neverallow { domain userdebug_or_eng(`-dumpstate -shell -su') } su_exec:file no_x_file_perms;
+neverallow { domain -dumpstate -shell -su } su_exec:file no_x_file_perms;

 # Do not allow the introduction of new execmod rules. Text relocations
 # and modification of executable pages are unsafe.
@@ -1197,7 +1197,7 @@ neverallow {
 # Only domains spawned from zygote, runas and simpleperf_app_runner may have the appdomain
 # attribute.
 neverallow { domain -simpleperf_app_runner -runas -app_zygote -webview_zygote -zygote } {
-  appdomain -shell userdebug_or_eng(`-su')
+  appdomain -shell -su
 }:process { transition dyntransition };

 # Minimize read access to shell- or app-writable symlinks.
diff --git a/public/hal_configstore.te b/public/hal_configstore.te
index 1a95b72f..edcdc267 100644
--- a/public/hal_configstore.te
+++ b/public/hal_configstore.te
@@ -31,7 +31,7 @@ neverallow hal_configstore_server {
   domain
   -hal_configstore_server
   -logd
-  userdebug_or_eng(`-su')
+  -su
   -tombstoned
   userdebug_or_eng(`-heapprofd')
 }:{ unix_dgram_socket unix_stream_socket } *;
diff --git a/public/installd.te b/public/installd.te
index f0ac52a0..eb78d9e6 100644
--- a/public/installd.te
+++ b/public/installd.te
@@ -173,5 +173,5 @@ neverallow installd {
     -ashmemd
     -system_server
     -servicemanager
-    userdebug_or_eng(`-su')
+    -su
 }:binder call;
diff --git a/public/netd.te b/public/netd.te
index c8877b24..540e04e9 100644
--- a/public/netd.te
+++ b/public/netd.te
@@ -158,7 +158,7 @@ neverallow {

 # apps may not interact with netd over binder.
 neverallow { appdomain -network_stack } netd:binder call;
-neverallow netd { appdomain -network_stack userdebug_or_eng(`-su') }:binder call;
+neverallow netd { appdomain -network_stack -su }:binder call;

 # persist.netd.stable_secret contains RFC 7217 secret key which should never be
 # leaked to other processes. Make sure it never leaks.
diff --git a/public/su.te b/public/su.te
index a2f435e1..b0ec6533 100644
--- a/public/su.te
+++ b/public/su.te
@@ -4,8 +4,8 @@ type su, domain;

 # File types must be defined for file_contexts.
 type su_exec, system_file_type, exec_type, file_type;
+type sudaemon, domain;

-userdebug_or_eng(`
   # Domain used for su processes, as well as for adbd and adb shell
   # after performing an adb root command.  The domain definition is
   # wrapped to ensure that it does not exist at all on -user builds.
@@ -101,4 +101,4 @@ userdebug_or_eng(`
   typeattribute su hal_wifi_hostapd_client;
   typeattribute su hal_wifi_offload_client;
   typeattribute su hal_wifi_supplicant_client;
-')
+
diff --git a/public/te_macros b/public/te_macros
index 85783dc9..f84c9c03 100644
--- a/public/te_macros
+++ b/public/te_macros
@@ -98,10 +98,10 @@ define(`pdx_service_socket_types', `
 typeattribute $2 pdx_$1_endpoint_dir_type;
 type pdx_$1_endpoint_socket, pdx_$1_endpoint_socket_type, pdx_endpoint_socket_type, file_type, coredomain_socket, mlstrustedobject, mlstrustedsubject;
 type pdx_$1_channel_socket, pdx_$1_channel_socket_type, pdx_channel_socket_type, coredomain_socket;
-userdebug_or_eng(`
+
 dontaudit su pdx_$1_endpoint_socket:unix_stream_socket *;
 dontaudit su pdx_$1_channel_socket:unix_stream_socket *;
-')
+
 ')

 #####################################
@@ -525,9 +525,9 @@ define(`build_test_only', ifelse(target_exclude_build_test, `true', , $1))
 # Fallback crash handling for processes that can't exec crash_dump (e.g. because of seccomp).
 #
 define(`crash_dump_fallback', `
-userdebug_or_eng(`
+
   allow $1 su:fifo_file append;
-')
+
 allow $1 anr_data_file:file append;
 allow $1 dumpstate:fd use;
 allow $1 incidentd:fd use;
diff --git a/public/vold.te b/public/vold.te
index 49523f43..0742ba3f 100644
--- a/public/vold.te
+++ b/public/vold.te
@@ -315,7 +315,7 @@ neverallow vold {
   -iorapd_service
   -servicemanager
   -system_server
-  userdebug_or_eng(`-su')
+  -su
 }:binder call;

 neverallow vold fsck_exec:file execute_no_trans;
--
2.27.0
